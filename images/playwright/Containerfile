ARG VERSION=1.57.0
FROM mcr.microsoft.com/playwright:v${VERSION}-noble

ENV PLAYWRIGHT_VERSION=${VERSION}

RUN set -xe \
    && apt update \
    && apt full-upgrade -y \
    && apt autoremove -y \
    && DEBIAN_FRONTEND=noninteractive apt install -y --no-install-recommends bind9-dnsutils ca-certificates curl \
       file iproute2 iputils-ping netcat-traditional procps vim-tiny \
    && update-alternatives --set editor /usr/bin/vim.tiny \
    && update-alternatives --install /usr/bin/vim vim /usr/bin/vim.tiny 1

RUN set -xe \
    && /usr/bin/npx -y playwright@${VERSION} install firefox --with-deps


EXPOSE 8080/tcp

HEALTHCHECK --start-period=30s CMD /usr/bin/curl -f http://127.0.0.1:8080/ws

# Shell invocation used to interpolate PLAYWRIGHT_VERSION. Shell
# replaced by exec so that shutdown signals go directly to npx.
CMD ["/bin/sh", "-c", "exec /usr/bin/npx playwright@${PLAYWRIGHT_VERSION} run-server --port 8080 --path /ws"]
